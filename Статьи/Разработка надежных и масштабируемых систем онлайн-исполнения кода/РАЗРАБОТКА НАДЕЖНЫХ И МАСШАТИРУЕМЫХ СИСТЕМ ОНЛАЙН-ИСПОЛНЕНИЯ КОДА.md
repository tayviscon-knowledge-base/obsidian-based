>  ![[tayviscon_long_logo.png|200]]
>  **Товкач Артем Юрьевич**
> tyomych.tovkach@tayviscon.com

***Аннотация* - В этой статье мы рассмотрим основные концепции разработки надежных и масштабируемых систем онлайн-исполнения кода, которые обладают современной модульной архитектурой и могут быть развернуты на произвольном количестве компьютеров и операционных систем. Мы изучим их дизайн и прокомментируем различные проблемы, возникающие при создании подобных систем, сравним несколько систем онлайн-исполнения кода, узнаем про системы онлайн-судейства и, наконец, приведем несколько сценариев использования для широкого спектра приложений, начиная от платформ для соревновательного программирования, образовательных и рекрутинговых платформ, а также онлайн-редакторов кода.** 
***Основные термины* - система онлайн-исполнения кода, система онлайн-судейства, выполнение небезопасного кода.** 
# ВВЕДЕНИЕ
Навык программирования признан одной из ключевых компетенция на современном рынке труда и спрос на предоставление качественных образовательных услуг в этой области превышает предложение. Уровень знаний и квалификации специалистов, предъявляемый к сотрудникам, все чаще заставляет образовательные организации отказываться от классических подходов к обучению и оценке знаний учащихся в пользу автоматизированных систем, основанных по принципу онлайн-судейства. Онлайн-судьи это системы, предназначенные для оценки исходного кода пользователя на заранее определенном наборе тестовых примеров. Существует множество различных категорий таких систем, которые можно классифицировать по предметной области их использования: платформы для соревновательного программирования, систем электронного обучения, платформы подбора персонала и т. д. Изучая дизайн архитектуры систем онлайн-судейства, можно понять, что их общим компонентом является движок исполнения кода, который использует некоторый механизм «песочницы» для безопасного выполнения исходного кода пользователя. Выделив движков исполнения кода в отдельный компонент и предоставив многофункциональный веб-интерфейс, можно создать надежную, масштабируемую и настраиваемую систему онлайн-исполнения кода, которая может быть интегрирована во множество различных типов систем онлайн-судейства. Во втором разделе мы исследуем и определим основные компоненты экосистемы онлайн-судей. После этого в третьем разделе мы определим систему онлайн-исполнения кода через функциональные и нефункциональные требования и в четвертом разделе мы изучим технические проблемы при создании систем онлайн-исполнения кода и представим современную архитектуру таких систем. Наконец, в пятом разделе мы приведем краткий обзор смежных работ, выполненных в области систем онлайн-исполнения кода.
# ЭКОСИСТЕМА ОНЛАЙН-СУДЕЙСТВА
На рисунке 1 показана многоуровневая архитектура экосистема онлайн-судейства, которая включает в себя компоненты, обычно ассоциирующиеся с такого рода системами, такие как платформы, построенные на основе систем онлайн-судейства и онлайн-калькуляторов, а также менее распространенные компоненты, на которые опираются системы онлайн-судейства: песочницы и системы онлайн-исполнения кода. Декомпозиция такого рода систем на отдельные слои позволяет нам лучше понять и определить функциональные и нефункциональные требования к каждому слою. 
В оставшейся части этой главы мы дадим определение и комментарий ко всем слоям, чтобы прояснить, как эти слои сочетаются друг с другом.
![[Архитектура экосистемы онлайн-судейства|1000]]
*Рисунок 1: Архитектура экосистемы онлайн-судейства*
## Песочница
Песочница - это механизм безопасности для разделения запущенных программ, часто используемых для выполнения небезопасного исходного кода. В контексте систем онлайн-судейства песочницы используются для обеспечения безопасности и для ограничения ресурсов, таких как память или процессор. 
Например, в соревновательном программировании каждая задача имеет определенные ограничения по времени и памяти, которые не должны быть превышены. Таком образом, при наличии хороших тестовых примеров и ограничений на ресурсы авторы задачи могут проверить, решил ли пользователь задачу с соответствующей по времени и памяти сложностью. 
Многие методы реализации песочниц могут быть использованы для изоляции небезопасного исходного кода с пользовательскими ограничениями на ресурсы, например, контейнеры LXC, Docker, виртуальные машины и другие.
В контексте системы онлайн-судейства мы ожидаем, что с помощью песочницы мы можем инициализировать среду исполнения, копировать пользовательский код и другие файлы в песочницу, компилировать и выполнять пользовательский код с ограничениями на ресурсы, собирать выходные данные программы и метаданные о выполнении, а также очищать среду песочницы.
## Движок исполнения кода
Механизм исполнения кода - это компонент систем онлайн-судейства, который использует песочницу для компиляции произвольного исходного кода внутри песочницы и для анализа различных метаданных генерируемых после компиляции и исполнения. Создание систем онлайн-судейства зачастую подразумевает создание движка исполнения кода, однако весьма редко встречается в литературе, посвященной системам онлайн-судейства.
## Системы онлайн-исполнения кода
Системы онлайн-исполнения кода - это (как правило, распределенные) системы, предоставляющие веб-интерфейс для компиляции и выполнения произвольного исходного кода . Они используются движок исполнения кода в качестве сервиса для компиляции и выполнения заданного исходного кода. 
На рисунке 2 показана архитектура системы онлайн-исполнения кода. До сих пор такого рода системы не привлекали особого внимания в литературе в контексте систем онлайн-судейства, так как были разработаны для конкретного случая использования, в котором  особенности работы системы онлайн-исполнения кода были скрыты внутри архитектуры систем онлайн-судейства.
![[Архитектура систем онлайн-исполнения кода|1000]]
*Рисунок 2: Архитектура системы онлайн-исполнения кода*
## Онлайн компиляторы и IDE
Онлайн-компиляторы (иногда называемые онлайн-редакторами), представляют собой онлайн-платформы, на которых пользователи могут писать, компилировать и исполнять свой исходный код на одном или нескольких языках программирования. Обычно они позволяют пользователям писать однофайловую программу, сохранять свои фрагменты и делиться ими с другими пользователями. Онлайн-IDE являются более продвинутыми онлайн-платформами, которые позволяют пользователям разрабатывать большие проекты в облаке. Некоторые онлайн-платформы имеют встроенные онлайн-редакторы кода, чтобы пользователи могли писать решения в браузере без необходимости устанавливать компилятор и редактор кода на свой компьютер.
## Системы онлайн-судейства
Система онлайн-судейства - это онлайн-сервис, который исполняет предоставленный код, производит его оценку и подсчитывает количество баллов в облаке. На первом этапе предоставленный пользователем код компилируется (если необходимо) и проверяется, что полученный двоичный файл запускается на заданном наборе тестовых примеров и для каждого из них проверяется, что процесс выполнения завершился без ошибок, лимиты ресурсов не были превышены и полученный результат соответствует правилам, описанным в определении задачи.  На последнем, оценочном этапе, количество баллов пользователя вычисляется на основе результатов, полученных на этапе оценки. В соответствии с приведенным выше определением, на рисунке 1 показана архитектура экосистемы онлайн-судейства, на которой указаны различные онлайн-платформы, которые могут быть построены на основе такого рода систем. Системы онлайн-судейства могут быть реализованы множеством различных способов, которые зависят от конкретного случая использования, но общая частью их функциональность является безопасное исполнения кода, оценка и выставление баллов за пользовательское решение.
## Онлайн-платформа как система онлайн-судейства
Различные категории систем-онлайн судейства, классифицируются по сценариям использования, однако их общей целью является оценка решения пользователем поставленной задачи, но сама оценка пользователя впоследствии используется для разных целей. Наиболее распространенными типами систем онлайн-судейства являются платформы соревновательного программирования для организации конкурсов по программированию или для решения различных задач по программированию для отработки свои навыков. Эти задачи имеют четко определенный формат входных и выходных данных и ожидают от пользователя реализации соответствующего алгоритма с использованием соответствующих структур данных, не превышая заданных ограничений на ресурсы, такие как время и память. Платформы электронного обучения также могут рассматриваться как системы онлайн-судейства, если они автоматически оценивают решения студентов. Они часто используются в образовательных учреждениях и в форме массовых открытых онлайн-курсов. Платформы для подготовки к собеседованиям - это еще один тип систем онлайн-судейства, которые пользователи могут использовать для отработки задач, алгоритмов и структур данных, которые встречаются в вопросах на собеседовании при приеме на работу в области программной инженерии. Платформы для подбора персонала - это такие системы онлайн-судейства, которые многие компании используют в процессе подбора персонала для оценки навыков кандидатов в различных задачах по программированию.
# СИСТЕМЫ ОНЛАЙН-ИСПОЛНЕНИЯ КОДА
В этой главе мы предлагаем отделить систему онлайн-исполнения кода от системы онлайн-судейства и рассматривать как отдельную сущность - «черный ящик», которые может быть использован для создания различных приложений, например, на основе систем онлайн-судейства. Системы онлайн-исполнения кода могут  быть определены с помощью функциональных и нефункциональных требований.
## Функциональные требования
Системы онлайн-исполнения кода **должны** предоставлять:
- хорошо документированный веб-интерфейс;
- поддержку компиляции и выполнения произвольного исходного кода, по крайней мере, для одного языка программирования;
- выполнение в песочнице, с предопределенными по умолчанию ресурсами;
- поддержку возврата результатов выполнения, включающих, по крайней мере, содержимое стандартного вывода;

Кроме того, системы онлайн-исполнения кода **могут** обеспечивать:
- указание пользовательских флагов для компилятора;
- указание пользовательских аргументов командной строки;
- задание ограничений на ресурсы, такие как лимит процессорного времени и лимит памяти;
- инициализация среды песочницы с несколькими файлами кроме исходного кода;
- возврат подробных результатов выполнения, таких как процессорное время и использование памяти, ошибки исполнения;
- возврат предупреждений или ошибок компиляции, если они существуют;
- пакетную отправку;
- множественный ввод;
- аутентифицированные запросы.

Конечно, чем большему количеству функциональных требований система удовлетворяет, тем больше случаев использования, которые она может охватить. 
## Нефункциональные требования
Система онлайн-исполнения кода должна быть:
- масштабируемо;
- конфигурируемой;
- безопасной,
- легко развертываемой;
- эффективной;
- устойчивый;
- расширяемой;
- надежный.

Чем большему количеству нефункциональных требований удовлетворяет система, тем
тем легче её интегрировать для конкретных платформ использования.
# ОБЗОР ОСНОВНЫХ КОНЦЕПЦИЙ РАЗРАБОТКИ СОВРЕМЕННЫХ СИСТЕМ ОНЛАЙН-ИСПОЛНЕНИЯ КОДА
Современные системы онлайн-исполнения кода отличатся масштабируемой архитектурой и все чаще используют новые подходы в создании систем онлайн-судейства. Разработка такого рода систем ставит перед собой цель: создание новой, надежной, масштабируемой, простой в использовании и расширяемой системы онлайн-исполнения кода, которая может быть легко интегрирована в различные веб-приложения.
## Требования и технические проблемы
При разработке систем онлайн-исполнения кода встречается большой ряд технических проблем, которые мы рассмотрим подробнее в следующих пунктах.
### Масштабируемость
Масштабируемость систем онлайн-исполнения код может быть достигнута с помощью трех стратегий. Первая заключается в масштабировании ряда движков исполнения кода выполняемых на одном компьютере. Количество движков определяет количество параллельных задач, которые могут выполняться одновременно. Эмпирические исследования показывают, что максимальное количество движков исполнения код, которые могут быть запущены, зависит от ресурсов компьютера и компиляторов/интерпретаторов, используемых для выполнения задач. Тем не менее, определение оптимального количества движков с учетом ресурсов компьютера и типа компилятора/интерпретатора все еще остается открытым вопросом для исследований. Текущие эмпирические исследования показывают, что оптимальным выбором для количества движков, выполняемых на одном компьютере равно количеству логических ядер процессора. Это масштабирование за счет увеличения ресурсов движка на одной машине соответствует вертикальному масштабированию за счет увеличения ресурсов и количества движков исполнения кода на одной машине и в определенный момент обязательно упирается в потолок. Именно тогда можно применить вторую, горизонтальную стратегию масштабирования.  Вторая стратегия масштабирования предполагает, что все компоненты системы онлайн-исполнения кода, показанные на рисунке 2, выполняются на одном компьютере. Благодаря тиражированию систем на несколько компьютеров и абстрагированию их за балансировщиком нагрузки достигается горизонтальное масштабирование. Обратите внимание, что вторая стратегия масштабирования может быть использована в комбинации с первой т.е. сначала определить и запустить максимальное количество движков исполнения кода, а затем горизонтально масштабировать до произвольного числа узлов. Третья стратегия масштабирования является более сложной, но использует компьютерные ресурсы более экономно. Если наша система имеет модульную архитектуру, где каждый модуль может быть легко развернут в виде контейнера Docker, то идея заключается в том, чтобы масштабировать только те части системы, которые могут стать узким местом. 
### Безопасность и песочница
Поскольку системы онлайн-исполнения кода позволяют пользователям запускать произвольный исходный код и двоичные файлы на удаленном сервере, вероятность атаки велика и исходный код или двоичный файл для каждого решения считается **небезопасным**. Он должен быть скомпилирован и запущен в среде песочницы.  На рисунке 3 представлен пример *isolate* для песочницы компиляции и исполнения. *Isolate* -  это хорошо известный и проверенный механизм песочницы для популярной системы онлайн-судейства по соревновательному программированию под названием CMS, который использовался на крупных конкурсах, таких как Международная олимпиада по информатике (IOI) и Центрально-Европейская олимпиада по информатике (CEOI).

![[Архитектура движка исполнения кода|1000]]
*Рисунок 3: Архитектура движка исполнения кода*

Другой аспект безопасности связан с широкими возможностями конфигурациями исполнения, такими как, например, установка пользовательского ограничения на максимальное время работы процессора. Современные системы онлайн-исполнения кода имеют богатые возможности конфигурации для ограничения ресурсов путем установки верхней и нижней границ, что позволяет им поддерживать множество различных сценариев использования. Стоит обратить внимание, что как компиляция, так и исполнение должны быть песочницами и ограничены по ресурсам. Чтобы лучше это понять давайте рассмотрим два примера кода, приведенные в листингах 1 и 2. В листинге 1 показана программа, написанная на языке программирования Си, которая включает в себя драйвер устройства псевдослучайных чисел Unix-систем, который генерирует бесконечную последовательность безопасных битов, что приводит к бесконечному времени компиляции.
```
#include </dev/random>
int main() {
	return 0;
}
```
*Листинг 1: Валидный код на языке Си с бесконечным временем компиляции*

Второй пример (листинг 2) демонстрирует атаку под названием "Fork Bomb", которая порождает множество процессов очень быстро, что приводит к истощению ресурсов компьютера, на котором она выполняется. В результате любой легитимный процесс не может приступить к выполнению своих задач, поскольку вредоносные процессы исчерпывают системные ресурсы.
```
#include <unistd.h>
int main() {
	while(1) {
		fork();
	}
	return 0;
}
```
*Листинг 2: Fork Bomb на языке программирования Си.*

Используя *isolate* в качестве среды песочницы, система онлайн-исполнения кода может безопасно компилировать и исполнять произвольный исходный код и даже двоичные файлы, полученные из неизвестного источника. Более того, разбирая метаданные выполнения из *isolate* движок исполнения кода может сохранять и сообщать статус каждой заявки и возможную причину неудачи (например, из-за превышения лимита времени, превышения лимита памяти и т.д.).
### Устойчивость
Система онлайн-исполнения кода должна быть разработана таким образом, чтобы противостоять любым попыткам злоумышленников с учетом следующего принципа: (злонамеренные попытки могут быть неудачными, но система будет продолжать функционировать в полном объеме). Устойчивость такого рода систем касается двух аспектов: 
- устойчивость к восстановлению после внутренних ошибок выполнения программы;
- устойчивость к отправке и приему произвольных данных.

Первый аспект достигается за счет разделения задач в движке исполнения кода. Вредоносный или ошибочный код, скорее всего, вызовет внутреннюю ошибку на одном из следующих этапов:
1. инициализация среды песочницы;
2. компиляция и исполнение исходного кода в песочнице;
3. очистка среды песочницы.

Если движок исполнения кода обнаруживает неопределенное или неожиданное поведение на любом из этапов, он вернет это со статусом "Внутренняя ошибка", сопровождаемым сообщением о статусе - причиной ошибки. 
Второй аспект надежности  можно продемонстрировать на примере программы показанной в листинге 3, которая выводит недопустимую последовательность байтов в формате UTF-8. Несмотря на то, что это корректная программа на языке Си и она выполняется без ошибок, результат работы этой программы, то есть содержимое ее стандартного вывода, не может быть отправлено в виде необработанной последовательности байтов в формате JSON. Система онлайн-исполнения кода может, например, позволять пользователям запрашивать Base64 закодированные данные в формате JSON.
```
#include <stdio.h>
int main() {
    printf("\xFE");
    return 0;
}
```
*Листинг 3: программа, выводящая содержимое, которое невозможно отправить в необработанном формате с помощью JSON*

### Простота использования и развертывания
Система онлайн-исполнения кода может иметь простой JSON веб-интерфейс, который имеет две основные точки: 
* создание новой заявки для одного из доступных языков;
* получение статуса заявки.

Первый endpoint создает новую заявку, которая должна содержать исходный код и уникальный идентификатор компилятора или интерпретатора, который должен быть использован для компиляции/интерпретации данного исходного кода. 
С помощью второй конечной точки пользователь может получить результат выполнения, то есть подробную информацию о результатах выполнения, таких как содержание стандартного вывода и стандартной ошибки, процессорного времени, использования памяти и т. д. С помощью только этих двух конечных точек можно создать простую систему онлайн-судейства для электронного обучения или онлайн-компилятора. Простоту развертывания можно достичь благодаря Docker, который позволяет развернуть систему на любой платформе, где установлен движок Docker Engine. 
### Архитектура и конвейер исполнения
Системы онлайн-исполнения кода имеет масштабируемую архитектуру, как показано на рисунках 2 и3. Более детальное взаимодействие между компонентами системы показано на рисунке 4.  
![[Диаграмма последовательности работы систем онлайн-исполнения кода|1000]]
*Рисунок 4: Диаграмма последовательности работы систем онлайн-исполнения кода*

Сначала клиент создает запрос к веб-интерфейсу API для создания нового запроса на обработку решения, предоставляя как минимум исходный код и желаемый язык программирования. Затем веб-интерфейс создает новую запись о запросе в базе данных и помещает только что созданную  заявку в очередь. После отправки в очередь, веб-интерфейс возвращает уникальный идентификатор, с помощью которого клиент может узнать статус обработки. Тем временем движок исполнения кода постоянно пытается извлечь следующую заявку из очереди. После получения заявки из очереди он инициализирует песочницу, подготавливает файлы в песочнице, компилирует исходный код, запускает скомпилированный двоичный файл, анализирует метаданные после исполнения кода и определяет статус заявки, очищает среду песочницы и, наконец, обновляет статус заявки в базе данных. Предполагается, что клиент будет постоянно делать запрос из веб-интерфейса до  момента пока не получится статус заявки о том, что она обработана. Такой механизм взаимодействия между клиентом и веб-интерфейсом характеризуется, как асинхронное выполнение, поскольку клиент не знает, когда обработка заявки будет завершена. Имеет смысл также реализовать поддержку другого типа взаимодействия - синхронного выполнения, при котором клиент сможет сразу получить результат заявки в качестве ответа системы. Текущие эмпирические исследования показывают, что системы с асинхронным типом взаимодействия лучше масштабируются, когда количество поступающих заявок значительно превышает количество заявок, которые могут быть обработаны движком исполнения кода в одно и то же время. С другой стороны, синхронное выполнение - это более простая парадигма для клиентских программ: проще реализовать один запрос-ответ.
# ДОПОЛНИТЕЛЬНЫЕ ИССЛЕДОВАНИЯ
Подробный обзор систем онлайн-судейства и приложений на них основанных был сделан ранее, однако системам онлайн-исполнения кода было уделено не так много внимания, поскольку системы онлайн-судейства разрабатываются для конкретных случаев использования, для которых система онлайн-исполнения кода скрыта внутри архитектуры систем онлайн-судейства. В дополнительном исследовании мы нашли две системы онлайн исполнения кода, которые были разработаны для соревновательного программирования. Первая из них - Sphere Engine, которая является коммерческим продуктом с закрытым исходным кодом, который предоставляет ограниченные возможности конфигурации. В то время, как описанная нами система раскрывает почти все возможности песочницы, которые предоставляет *isolate*. Другой системой онлайн исполнения кода является camisole, которая также использует *isolate* в качестве среды песочницы. Она имеет открытый исходный код, однако не использует все параметры конфигурации, предоставляемые *isolate*,  а только основные, которые важны для соревновательного программирования. Развертывание camisole осуществляется либо путем загрузки готового образа виртуальной машины, либо путем ручной установки. Этот тип процедуры не является легко масштабируемым как тот, который мы описали выше в статье. В заключение следует отметить, что обе эти системы ориентированы на соревновательное программирование, в то время как описанная нами система представляет собой решение общего назначения.
# ЗАКЛЮЧЕНИЕ 
С ростом спроса на образование в области компьютерных наук, развитием технологий и увеличением пользователей, предпочитающих дистанционный формат обучения потребность в системах онлайн-исполнения кода и оценке кода значительно растет. Системы онлайн-судейства, как правило, создаются с учетом конкретных условий использования, например, для соревновательного программирования, электронного обучения, рекрутинга и т.д. и они обычно имеют систему онлайн-исполнения кода, скрытую в их архитектуре, что позволяет запускать пользовательский код в безопасной и изолированной среде. В данной статье мы рассказали о новой архитектуре системы онлайн-исполнения кода, которую определили с помощью функциональных и нефункциональных требований. Наконец, предложенная система, является надежной, конфигурируемой и масштабируемой, обладает многофункциональным веб-интерфейсом, который может быть использован для множества различных случаев использования. 